AWSTemplateFormatVersion: '2010-09-09'

Parameters:
  Environment:
    Type: String
    Default: 'dev'
    AllowedValues:
      - dev
      - prod
  
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: The ID of the VPC where the resources will be deployed.

Conditions:
  IsDev: !Equals [!Ref Environment, 'dev']

Resources:
  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'crow-detector-db-sg-${Environment}'
      GroupDescription: !Sub 'Enable access to Postgres on port 5432 for ${Environment} environment'
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: !If 
            - IsDev
            - 76.115.125.73/32
            - 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref ECSTaskSecurityGroup

  ECSTaskSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub 'crow-detector-ecs-sg-${Environment}'
      GroupDescription: !Sub 'Security group for ECS tasks in ${Environment} environment'
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
          SourceSecurityGroupId: !If 
            - IsDev
            - !ImportValue crow-detector-alb-sg-dev
            - !ImportValue crow-detector-alb-sg-prod
        - IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
          CidrIp: !If 
            - IsDev
            - 76.115.125.73/32
            - 0.0.0.0/1
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

Outputs:
  DatabaseSecurityGroupId:
    Description: The ID of the database security group
    Value: !Ref DatabaseSecurityGroup
    Export:
      Name: !Sub 'crow-detector-db-sg-${Environment}'

  ECSTaskSecurityGroupId:
    Description: The ID of the ECS task security group
    Value: !Ref ECSTaskSecurityGroup
    Export:
      Name: !Sub 'crow-detector-ecs-sg-${Environment}' 