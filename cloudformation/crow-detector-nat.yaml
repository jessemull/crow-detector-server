AWSTemplateFormatVersion: '2010-09-09'
Description: 'NAT Instance for Private Subnet Internet Access and Bastion Host'

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: The ID of the VPC where the resources will be deployed.

  PublicSubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: The ID of the public subnet where the NAT instance will be deployed.

  BastionIP:
    Type: String
    Default: '76.115.125.73/32'
    Description: Your IP address for SSH access to the NAT instance (bastion host).

Resources:
  NATInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: 'crow-detector-nat-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: Name
          Value: 'crow-detector-nat-role'

  NATInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: 'crow-detector-nat-profile'
      Roles:
        - !Ref NATInstanceRole

  NATSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: 'crow-detector-nat-sg'
      GroupDescription: 'Security group for NAT instance and bastion host'
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        # SSH access from your IP.

        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref BastionIP
        # Allow all traffic from private subnets.

        - IpProtocol: -1
          CidrIp: 10.0.0.0/8
      SecurityGroupEgress:
        # Allow all outbound traffic.

        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: 'crow-detector-nat-sg'

  NATInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.nano
      ImageId: ami-0efdf839508ec2995  # Amazon Linux 2023 AMI 2023.8.20250808.1 x86_64 HVM kernel-6.1 in us-west-2
      SubnetId: !Ref PublicSubnetId
      SecurityGroupIds:
        - !Ref NATSecurityGroup
      IamInstanceProfile: !Ref NATInstanceProfile
      SourceDestCheck: false
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          # Enable IP forwarding for NAT
          echo 1 > /proc/sys/net/ipv4/ip_forward
          
          # Configure iptables for NAT
          iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
          
          # Save iptables rules
          service iptables save
          
          # Enable iptables service
          systemctl enable iptables
          systemctl start iptables
          
          # Install and configure CloudWatch agent for monitoring
          yum install -y amazon-cloudwatch-agent
          
          # Create CloudWatch config
          cat > /opt/aws/amazon-cloudwatch-agent/bin/config.json << 'EOF'
          {
            "metrics": {
              "metrics_collected": {
                "disk": {
                  "measurement": ["used_percent"],
                  "metrics_collection_interval": 60,
                  "resources": ["*"]
                },
                "mem": {
                  "measurement": ["mem_used_percent"],
                  "metrics_collection_interval": 60
                }
              }
            }
          }
          EOF
          
          # Start CloudWatch agent
          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json
          
          # Tag the instance
          aws ec2 create-tags --resources $(curl -s http://169.254.169.254/latest/meta-data/instance-id) --tags Key=Name,Value=crow-detector-nat --region ${AWS::Region}
      Tags:
        - Key: Name
          Value: 'crow-detector-nat'
        - Key: Purpose
          Value: 'NAT and Bastion Host'

Outputs:
  NATInstanceId:
    Description: ID of the NAT instance
    Value: !Ref NATInstance
    Export:
      Name: 'crow-detector-nat-instance'

  NATInstancePrivateIP:
    Description: Private IP address of the NAT instance
    Value: !GetAtt NATInstance.PrivateIp
    Export:
      Name: 'crow-detector-nat-private-ip'

  NATSecurityGroupId:
    Description: ID of the NAT instance security group
    Value: !Ref NATSecurityGroup
    Export:
      Name: 'crow-detector-nat-sg'

  NATInstanceRoleArn:
    Description: ARN of the NAT instance IAM role
    Value: !GetAtt NATInstanceRole.Arn
    Export:
      Name: 'crow-detector-nat-role-arn'
